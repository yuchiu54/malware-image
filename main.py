import os
import sys

from PIL import Image
from queue import Queue

def get_binary_data(filename):
    binary_values = []
    with open(filename, 'rb') as f:
        data = f.read(1)
        while data != b'':
            binary_values.append(ord(data))
            data = f.read(1)
    return binary_values

def get_size(data_length):    
    width = None        
    size = data_length        
    if (size < 10240):        
        width = 32            
    elif (10240 <= size <= 10240 * 3):        
        width = 64        
    elif (10240 * 3 <= size <= 10240 * 6):        
        width = 128        
    elif (10240 * 6 <= size <= 10240 * 10):        
        width = 256        
    elif (10240 * 10 <= size <= 10240 * 20):        
        width = 384        
    elif (10240 * 20 <= size <= 10240 * 50):        
        width = 512        
    elif (10240 * 50 <= size <= 10240 * 100):        
        width = 768        
    else:        
        width = 1024        
    height = int(size / width) + 1        
    return (width, height)        

def save_file(filename, data, size, image_type):
    try:
        image = Image.new(image_type, size)
        image.putdata(data)

        dirname = os.path.dirname(filename)
        name, _ = os.path.splitext(filename)
        name    = os.path.basename(name)
        imagename = os.curdir+ os.sep + image_type + os.sep + name + '_' + image_type + '.png'
        os.makedirs(os.path.dirname(imagename), exist_ok=True)

        image.save(imagename)
        print('The file ', imagename, ' saved.')
    except Exception as err:
        print(err)

def create_grayscale_image(filename):
    grayscale_data = get_binary_data(filename)
    size = get_size(len(grayscale_data))
    save_file(filename, grayscale_data, size, 'L')

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print('malware file require')
        exit()
    filename = sys.argv[1]
    create_grayscale_image(filename)
